# 第12章 磁盘和文件管理以及`simple.file`包的实现

在本章中，我们研究数据库系统如何将其数据存储在磁盘和闪存驱动器等物理设备上。 我们研究了这些设备的属性，并考虑了可以提高其速度和可靠性的技术（例如RAID）。 我们还将研究操作系统提供的用于与这些设备进行交互的两种接口（块级接口和文件级接口），并讨论哪种接口最适合数据库系统。 最后，我们详细研究`SimpleDB`的文件管理器，研究其API及其实现。

## 12.1 持久化数据存储

数据库的内容必须保持持久性，以便在数据库系统或计算机出现故障时不会丢失数据。本节研究了两种特别有用的硬件技术：`磁盘驱动器(disk drives)`和`闪存驱动器(flash drives)`。

> 磁盘驱动器和闪存驱动器是最常用的持久化存储设备。

闪存驱动器没有磁盘驱动器运用的那么广泛。但是，随着技术的成熟，它们的重要性将会提高。我们从磁盘驱动器开始，然后再考虑闪存驱动器。

### 12.1.1 磁盘驱动器

磁盘驱动器包含一个或多个可旋转的`盘片（platter）`。盘片具有很多同心`磁道（tracks）`，每个磁道由一系列字节组成。通过带有读/写头的可移动磁臂从盘片中读取字节（或者将字节写入盘片）。当磁臂移动至所需的磁道上时，磁头可以读取（或写入）字节它旋转时位于在其下方的字节。图12-1描绘了一个单盘片驱动器的俯视图。当然，该图不是按比例绘制的，因为典型的盘片具有成千上万的磁道。

![](ch12/12-1.png)

现代的磁盘驱动器通常都会有很多盘片，为了空间效率考虑，通常都会量成对的盘片背对背地连接在一起，形成看起来像双面盘片的样子；但从概念上讲，盘片的任一面应该是是一个单独的盘片，每个盘片都有自己的读/写头，这些磁头理应是独立移动的；但实际上，它们都连接到一个`致动器（actuator）`，该致动器将它们同时移动到每个盘片上的同一磁道上， 而且，所有磁道中一次只能有一个读/写头处于活动状态，因为到计算机的数据路径（datapath）只有一个。图12-2描绘了多磁盘驱动器的侧视图。

![](ch12/12-2.png)

我们现在考虑如何表征一个磁盘驱动器的性能。

> 一个磁盘驱动器的大体上的性能可以通过下面几个量来表示：它的`容量(capacity)`，`转速(rotation speed)`，`传输速率(transfer rate)`和`平均寻道时间(average seek time)`。

驱动器的`容量(capacity)`是可以存储的字节数。该值取决于盘片的数量，每个盘片的磁道数以及每个磁道的字节数。鉴于当前盘片或多或少的尺寸标准，很多磁盘制造商主要通过增加磁盘的的密度来增加磁盘的容量，即将更多的磁道集成在一个盘片上，并且让每个磁道存储更多的字节。现在容量超过40GB的盘片很常见。

`转速(rotation speed)`是盘片旋转的速率，通常表示为每分钟旋转的圈数。典型速度范围为5400rpm至15000rpm不等。

`传输速率(transfer rate)`指的是字节通过磁盘头的读写，从而被传输到内存的速率。例如，整个磁道的字节可以在盘片旋转一周的时间内传输完成，因此，传输速率由盘片的旋转速度和每个磁道上的的字节数共同决定。常见的速率为100MB/秒。

`寻道时间(seek time)`是制动器将磁盘的磁头从当前位置移动到所需轨道所花费的时间。
这个值取决于需要移动多少个磁道，最低可以低至0（如果目标磁道与起始磁道相同），最高可达15-20毫秒（如果目标磁道和起始磁道刚好在一个盘片的最外侧和最内侧）。平均寻道时间通常是对制动器移动速度的合理估计。现代磁盘的平均寻道时间约为5毫秒。

考虑下面的例子：

> 一个拥有4个盘片，转速为10000rpm，且平均寻道时间为5ms的磁盘。每个盘片有10000个磁道，每个磁道上包含50万个字节，我们可以进行以下计算：
磁盘的容量为： 5 x 10^5 字节/磁道 x 10^4磁道/盘片 x 4盘片/磁盘 = 20 x 10^9 字节 （20 GB）
磁盘的传输速率为： 5 x 10^5 字节/转 x 10^4 转/60s = 8.3 x 10^7字节/秒 （83兆字节/秒）

### 12.1.2 访问磁盘驱动器
一次`磁盘访问（disk access）`指的是一次从磁盘到内存的读请求或者内存到磁盘的写请求。这些字节必须在某个盘片的某些磁道上的连续区域。

磁盘驱动器按照以下3个步骤执行一次磁盘访问：
- 首先将磁头移到目标磁道，如图前文所说，这个时间交寻道时间。
- 再等待盘片旋转，直到磁头下对应的字节为我们期望的的首字节，这个时间被叫做`旋转延时(rotational delay)`
- 盘片继续旋转，磁头不断地将字节读取（或者写入到磁道上），直到最后一个字节。整个这个过程的用时被称为`传输用时(transfer time)`。

> 执行一次磁盘访问的总用时为寻道时间，旋转延时和传输用时的总和。

注意，上述的这些时间都是受到磁盘机械旋转(mechanical movement)的限制的，而机械旋转又显然比电旋转(electrical movement)慢很多,这也是为什么磁盘驱动器会比RAM慢很多的原因。寻道时间和旋转延时特别烦人，它们只不过就是每次磁盘操作前必须等待的时间罢了。

计算一次磁盘访问的准确寻道时间和旋转延时是不实际的，因为它需要知道磁盘的当前状态，相反，我们可以通过使用它们的平均值来估计这些时间。我们已经知道平均寻道时间。 平均旋转延时也很容易计算，旋转延时可以低至0（如果第一个字节恰好位于当前磁头下方），以及高达一次完整的旋转用时（即第一个字节刚刚已经错过了磁头），平均而言，我们将不得不等待1/2次旋转，直到盘片旋转到在我们想要的磁道位置，因此，平均旋转延时是旋转时间的一半。

传输用时也可以很容易通过传输速率计算得到，举例来说，如果一个磁盘的传输速率为$$b_1 B/s$$,我们需要传输$$b_2 B$$，则传输时间为$$b_2/b_1 $$秒

继续我们之前的例子，我们可以估计一次磁盘访问的耗时如下：

> 考虑一个10000rpm的磁盘，平均寻道时间为5秒，传输速率为83Mb/s
平均旋转延时为： 60 s/min x 1 min/10000 转 x 0.5转= 3 ms
传输1字节用时为： 1 B x 1s/83M B = 1.2 x 10^-5 ms 
传输1000字节用时为： 1000  x 1.2 x 10^-5 ms = 1.2 x 10^-2
1字节的一次磁盘访问估计用时为：5ms（寻道时间） + 3ms（平均旋转延时）+  1.2 x 10^-5 ms （传输用时） = 8.000012 ms
1000字节的一次磁盘访问估计用时为：5ms（寻道时间） + 3ms（平均旋转延时）+  1.2 x 10^-2 ms （传输用时） = 8.012 ms

可以注意到，传输1000字节和传输1字节的整体估计用时几乎是一样的，也就是说，只访问很少字节对磁盘访问读写时间来说没有影响，实际上，如果你真的只想读一个字节，底层也不会有这样的支持。现代的磁盘都会将一个磁道分成很多的`扇区（sectors）`；一次磁盘的读写必须是以整个扇区为最小操作单位的，具体每个扇区的大小由磁盘制造商来决定，在磁盘出厂时就已经被确定了，一个常见的扇区大小为512字节。

### 12.1.3 改进磁盘访问时间

因为磁盘驱动器很慢，有一些技术已经被提出来改进磁盘访问时间，我们将考虑三种技术：`磁盘缓存(disk cache)`，`扇区（cylinder）`和`磁盘分条（disk striping）`

***磁盘缓存***

磁盘缓存是与磁盘驱动器绑定在一起的一块内存区域，该缓存区通常足够大从而存储许多磁道数据。每当磁盘驱动器从磁盘读取一个扇区时，它都会将该扇区的内容保存在其高速缓存中。如果缓存已满，则新扇区将替换旧扇区。当请求扇区时，磁盘驱动器将检查缓存，如果该扇区恰好在高速缓存中，则可以将其立即返回计算机，而无需实际的磁盘访问。

假设一个应用程序在相对较短的时间内多次请求相同的扇区。然后，第一个请求会将扇区带入缓存，随后的请求将从缓存中检索该扇区，从而节省磁盘访问时间。然而，这个功能对数据库系统不是特别重要，因为数据库系统已经以相同的方式进行了缓存（如我们将在第13章中看到的那样）。如果多次请求一个扇区，则数据库服务器将在其自己的缓存中找到该扇区，甚至不必费心去磁盘。

以下是为什么磁盘缓存很有价值的真正原因。假设磁盘从不一次读取单个扇区，磁盘驱动器不只是读取请求的扇区，而是将包含该扇区的整个磁道读取到高速缓存中，且认为在不久的将来，该磁道上的其他扇区也会被请求。关键是，读取整个磁道并不会比读取单个扇区浪费很多时间（和我们上述计算时读取一个字节和读取1000个字节的例子类似）。特别地，这种情况将没有旋转延迟，因为磁盘可以从读/写头下方的任何扇区开始读取磁道，并在整个旋转过程中继续读取。以下是两种访问模式的访问用时对比：

> 读一个扇区的时间：寻道时间 + 1/2 旋转用时 + 磁头读取字节时旋转用时
读一个磁道的时间：寻道时间 +  磁头读取字节时旋转用时